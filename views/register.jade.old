extends layout
block title
	Регистрация
block content
	.page-header
		h1 Регистрация
	if error === true
		.alert.alert-error
			a.close(href='#', data-dismiss='alert') &times;
			if loginIsBusy === true
				b Извините! Это имя уже занято.
				| #{' '}Придумайте какое-нибудь другое.
			else
				b Ой! Во введённых данных что-то не так.
				| #{' '}Исправьте ошибки и попробуйте ещё раз.
	form.form-horizontal(method='post', action='/register/')
		#user-control-group.control-group(class=((invalidLogin || loginIsBusy)?'error':''))
			label.control-label(for='user') Логин
			.controls
				input#user(type='text', name='user', maxlength='32', value=user, required, autofocus)
				span.help-inline
					small От 2 до 32 символов, [a-zA-Z0-9а-яА-Я_- ].
		#password-control-group.control-group(class=(invalidPass?'error':''))
			label.control-label(for='pass') Пароль
			.controls
				input#pass(type='password', name='pass', maxlength='32', required)
				span.help-inline
					a#revealpass.btn.btn-small(title='Показать пароль')
						i.icon-eye-open
					small #{' '}От 4 до 32 символов, [a-zA-Z0-9!@#$%^&amp;*()_+]
		.control-group
			.controls
				button.btn(type='submit') Зарегистрироваться
	script(src='/static/browserified/validation.min.js')
	:coffee
		# Common variables
		usernameField = $('input[name=user]')
		usernameControlGroup = $('#user-control-group')
		passwordField = $('input[name=pass]')
		passwordControlGroup = $('#password-control-group')
		revealPasswordButton = $('#revealpass')

		# Reveal password
		revealPasswordButton.click ->
			passwordField.prop 'type', (if passwordField.prop('type') is 'password' then 'text' else 'password')

		# Validate password
		passwordField.change ->
			if validation.passwordIsValid(passwordField.val())
				passwordControlGroup.removeClass 'error'
			else
				passwordControlGroup.addClass 'error'

		# Validate username
		usernameField.change ->
			usernameControlGroup.removeClass 'error'
			if validation.usernameIsValid(usernameField.val())
				$.getJSON "/ajax/isNickBusy/#{encodeURIComponent(usernameField.val())}", (data) ->
					if data.isNickBusy and data.nick == usernameField.val()
						usernameControlGroup.addClass 'error'
			else
				usernameControlGroup.addClass 'error'
